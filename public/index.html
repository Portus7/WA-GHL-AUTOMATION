<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Conectar WhatsApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Estilos ultra simples -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    .card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      text-align: center;
      width: 100%;
      max-width: 360px;
    }

    h1 {
      font-size: 1.3rem;
      margin-bottom: 12px;
    }

    p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 16px;
    }

    button {
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #message {
      margin-top: 12px;
      font-size: 0.85rem;
      color: #444;
      min-height: 1em;
    }

    #qr {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }
  </style>

  <!-- Librer√≠a peque√±a para generar QR en el navegador -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Conectar WhatsApp</h1>
    <p>
      Haz clic en el bot√≥n para iniciar la conexi√≥n y generar el c√≥digo QR.
      Luego escan√©alo con la app de WhatsApp.
    </p>

    <!-- √öNICO BOT√ìN -->
    <button id="btn-connect">Conectar WhatsApp</button>

    <div id="message"></div>
    <div id="qr"></div>
  </div>

<script>
  const btn = document.getElementById("btn-connect");
  const msg = document.getElementById("message");
  const qrContainer = document.getElementById("qr");

  let qrPolling = null;
  let statusPolling = null;

  btn.addEventListener("click", async () => {
    // limpiar estado anterior
    qrContainer.innerHTML = "";
    msg.textContent = "";

    if (qrPolling) {
      clearInterval(qrPolling);
      qrPolling = null;
    }
    if (statusPolling) {
      clearInterval(statusPolling);
      statusPolling = null;
    }

    btn.disabled = true;
    msg.textContent = "Iniciando conexi√≥n con WhatsApp...";

    try {
      const res = await fetch("/start-whatsapp", {
        method: "POST",
      });
      if (!res.ok) {
        throw new Error("No se pudo iniciar la conexi√≥n");
      }

      msg.textContent = "Conexi√≥n iniciada. Esperando c√≥digo QR...";

      // üîÅ Consultar cada 3s el QR
      qrPolling = setInterval(checkQR, 3000);

      // üîÅ Consultar estado de conexi√≥n
      statusPolling = setInterval(checkStatus, 3000);
    } catch (err) {
      console.error(err);
      msg.textContent =
        "Error iniciando la conexi√≥n. Revisa la consola del servidor.";
      btn.disabled = false;
    }
  });

  async function checkQR() {
    try {
      // üëá bust de cach√© en el navegador
      const res = await fetch("/qr?ts=" + Date.now(), {
        cache: "no-store",
      });

      if (!res.ok) {
        // 404 => a√∫n no hay QR o se limpi√≥ al conectar
        return;
      }

      const data = await res.json();
      const qrText = data.qr;

      console.log("QR recibido desde backend:", qrText.substring(0, 20) + "...");

      // Redibujar siempre el QR actual
      qrContainer.innerHTML = "";
      new QRCode(qrContainer, {
        text: qrText,
        width: 256,
        height: 256,
      });

      msg.textContent = "Escanea este c√≥digo QR con la app de WhatsApp.";
    } catch (err) {
      console.error(err);
    }
  }

  async function checkStatus() {
    try {
      const res = await fetch("/status", { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      if (data.whatsappConnected) {
        console.log(data)
        msg.textContent = "‚úÖ WhatsApp conectado.";
        if (qrPolling) clearInterval(qrPolling);
        if (statusPolling) clearInterval(statusPolling);
        qrPolling = null;
        statusPolling = null;
        btn.disabled = false;

        // opcional: limpiar el QR cuando ya est√° conectado
        qrContainer.innerHTML = "";
      }
    } catch (err) {
      console.error(err);
    }
  }
</script>

</body>
</html>
