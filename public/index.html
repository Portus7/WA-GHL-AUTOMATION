<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Multi-Device</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background: #f3f4f6; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
    .container { width: 100%; max-width: 500px; }
    h1 { text-align: center; color: #1f2937; margin-bottom: 30px; }
    
    .slot-card {
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.2s;
    }
    .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .slot-title { font-weight: 700; font-size: 1.1rem; color: #374151; }
    
    /* Estados */
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.8rem; font-weight: 600; }
    .badge-off { background: #fee2e2; color: #991b1b; }
    .badge-on { background: #dcfce7; color: #166534; }

    .btn {
      width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem;
      background: #25D366; color: white; display: block;
    }
    .btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: default; }
    .btn-delete { background: #ef4444; margin-top: 10px; }

    .qr-area { margin-top: 15px; display: flex; flex-direction: column; align-items: center; display: none; }
    .qr-area.active { display: flex; }
    .qr-canvas { margin: 10px 0; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
    .status-msg { font-size: 0.85rem; color: #6b7280; margin-top: 5px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<div class="container">
  <h1>Gestión de Números</h1>
  <div id="slots-container"></div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const locationId = params.get("location_id") || params.get("locationId");

  if (!locationId) {
    document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px'>Error: Falta location_id</h3>";
  }

  const TOTAL_SLOTS = 3;
  const intervals = {}; // Guardar intervalos de polling por slot

  // Renderizar Slots
  const container = document.getElementById("slots-container");
  
  for (let i = 1; i <= TOTAL_SLOTS; i++) {
    const html = `
      <div class="slot-card" id="card-${i}">
        <div class="slot-header">
          <div class="slot-title">Dispositivo #${i}</div>
          <div id="badge-${i}" class="badge badge-off">Desconectado</div>
        </div>

        <div id="connected-view-${i}" style="display:none">
           <p style="color:#059669; font-size:0.9rem; margin:0 0 10px 0;">
             ✅ WhatsApp Conectado: <strong id="phone-${i}">...</strong>
           </p>
           <button class="btn" disabled>Conectado</button>
        </div>

        <div id="disconnected-view-${i}">
           <button id="btn-${i}" class="btn" onclick="startConnect(${i})">Conectar WhatsApp</button>
           <div id="qr-area-${i}" class="qr-area">
              <div id="qr-canvas-${i}" class="qr-canvas"></div>
              <span id="msg-${i}" class="status-msg">Generando QR...</span>
           </div>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    checkStatus(i); // Verificar estado inicial
  }

  async function checkStatus(slot) {
    try {
      const res = await fetch(`/status?locationId=${locationId}&slot=${slot}`);
      const data = await res.json();
      updateUI(slot, data.connected, data.myNumber);
    } catch (e) { console.error(e); }
  }

  function updateUI(slot, isConnected, phone) {
    const badge = document.getElementById(`badge-${slot}`);
    const viewCon = document.getElementById(`connected-view-${slot}`);
    const viewDisc = document.getElementById(`disconnected-view-${slot}`);
    const phoneText = document.getElementById(`phone-${slot}`);
    const qrArea = document.getElementById(`qr-area-${slot}`);

    if (isConnected) {
      badge.className = "badge badge-on";
      badge.textContent = "En Línea";
      viewCon.style.display = "block";
      viewDisc.style.display = "none";
      phoneText.textContent = "+" + phone;
      qrArea.classList.remove("active");
      
      // Detener polling si existe
      if (intervals[slot]) { clearInterval(intervals[slot]); delete intervals[slot]; }
    } else {
      badge.className = "badge badge-off";
      badge.textContent = "Desconectado";
      viewCon.style.display = "none";
      viewDisc.style.display = "block";
    }
  }

  async function startConnect(slot) {
    const btn = document.getElementById(`btn-${slot}`);
    const qrArea = document.getElementById(`qr-area-${slot}`);
    const msg = document.getElementById(`msg-${slot}`);
    const qrCanvas = document.getElementById(`qr-canvas-${slot}`);

    btn.disabled = true;
    btn.textContent = "Iniciando...";
    qrArea.classList.add("active");
    qrCanvas.innerHTML = ""; // Limpiar

    try {
      await fetch(`/start-whatsapp?locationId=${locationId}&slot=${slot}`, { method: "POST" });
      
      msg.textContent = "Escanea el código QR...";
      
      // Iniciar Polling para QR y Status
      if (intervals[slot]) clearInterval(intervals[slot]);
      
      intervals[slot] = setInterval(async () => {
        // 1. Check Status
        const statRes = await fetch(`/status?locationId=${locationId}&slot=${slot}`);
        const statData = await statRes.json();
        
        if (statData.connected) {
          updateUI(slot, true, statData.myNumber);
          return;
        }

        // 2. Get QR
        const qrRes = await fetch(`/qr?locationId=${locationId}&slot=${slot}`);
        if (qrRes.ok) {
          const qrData = await qrRes.json();
          if (qrData.qr && qrCanvas.innerHTML === "") {
             new QRCode(qrCanvas, { text: qrData.qr, width: 180, height: 180 });
             btn.textContent = "Esperando escaneo...";
          }
        }
      }, 3000);

    } catch (e) {
      msg.textContent = "Error al conectar";
      btn.disabled = false;
    }
  }
</script>

</body>
</html>